// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts          Account[]
  sessions          Session[]
  clientOnboardings ClientOnboarding[]

  orders    Order[]    @relation("UserOrders")
  prospects Prospect[] @relation("UserProspects")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model ClientOnboarding {
  id String @id @default(cuid())

  // Personal Information
  gender                  String?
  phoneNumber             String?
  personalEmail           String?
  residentialAddress      String?
  nationality             String?
  passportNumber          String?
  passportExpiryDate      String?
  dateOfBirth             String?
  taxResidency            String?
  taxIdentificationNumber String?

  // Project Information
  projectName  String?
  projectEmail String?

  // KYC Documents (file paths or URLs)
  passportCopy   String?
  proofOfAddress String?
  bankStatement  String?

  status    String   @default("PENDING")
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyIncorporations CompanyIncorporation[]

  orders    Order[]    @relation("OnboardingOrders")
  prospects Prospect[] @relation("OnboardingProspects")

  @@map("client_onboardings")
}

model CompanyIncorporation {
  id           String  @id @default(cuid())
  onboardingId String  @unique
  jurisdiction String?

  // ============================================
  // BVI FIELDS
  // ============================================
  companyNames               Json?
  relevantIndividuals        Json?
  sourceOfFunds              Json?
  recordsLocation            Json?
  declaration                Json?
  requiresNomineeShareholder Boolean @default(false)
  shareholders               Json?
  requiresNomineeDirector    Boolean @default(false)
  directors                  Json?

  // ============================================
  // PANAMA
  // ============================================
  panamaLegalEntity     Json?
  panamaBeneficialOwner Json?
  panamaDirectors       Json?

  // ============================================
  // SINGAPORE
  // ============================================
  singaporeCompanyDetails Json?
  singaporeShareholders   Json?
  singaporeDirectors      Json?
  singaporeDeclaration    Json?

  // ============================================
  // CAYMAN (Three forms)
  // ============================================
  caymanEntityInstruction Json?     // Form 1
  caymanDueDiligence      Json?     // Form 2
  caymanBoDeclaration     Json?     // Form 3

  // ============================================
  // SIMPLE FIELDS (BVI Style)
  // ============================================
  purposeOfCompany      String?
  geographicProfile     Json?
  authorizedShares      String?
  sharesParValue        String?
  currency              String? @default("USD")
  customShares          String?
  customParValue        String?
  complexStructureNotes String?

  // ============================================
  // HONG KONG FIELDS
  // ============================================
  companySecretary Json?
  registeredOffice Json?
  shareCapital     Json?

  // ============================================
  // SIGNATURE METADATA (used across all jurisdictions)
  // ============================================
  signature          String?
  signatureType     String?
  signatureFilePath String?
  signatureFileName String?
  completedByName   String?
  signedAt          DateTime?
  ipAddress         String?
  userAgent         String?

  // ============================================
  // META
  // ============================================
  status    String   @default("draft")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation
  onboarding ClientOnboarding @relation(fields: [onboardingId], references: [id], onDelete: Cascade)

  @@map("company_incorporations")
}

model Order {
  id              String    @id @default(cuid())
  orderCode       String    @unique
  userId          String
  onboardingId    String
  jurisdiction    String
  status          String    @default("pending_payment")
  firstNameLockAt DateTime?
  lastEmailAt     DateTime?

  user       User             @relation("UserOrders", fields: [userId], references: [id], onDelete: Cascade)
  onboarding ClientOnboarding @relation("OnboardingOrders", fields: [onboardingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([onboardingId, status])
  @@map("orders")
}

model Prospect {
  id             String  @id @default(cuid())
  userId         String
  onboardingId   String? // optional link (the user might not have an onboarding yet)
  jurisdiction   String? // e.g. "BVI", "HK"
  rawName        String // the original string the user typed
  normalizedName String // normalized for dedup/search (uppercase, trim, no spaces etc.)
  status         String  @default("new") // new | checking | reserved | rejected | completed
  notes          String? // optional internal notes

  // Relations
  user       User              @relation("UserProspects", fields: [userId], references: [id], onDelete: Cascade)
  onboarding ClientOnboarding? @relation("OnboardingProspects", fields: [onboardingId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, normalizedName, jurisdiction]) // avoid duplicates per user/jurisdiction
  @@index([userId, jurisdiction])
  @@map("prospects")
}

model EmailVerification {
  id         String    @id @default(cuid())
  email      String
  codeHash   String
  expiresAt  DateTime
  attempts   Int       @default(0)
  consumedAt DateTime?
  ip         String?
  createdAt  DateTime  @default(now())

  @@index([email])
  @@index([expiresAt])
}
